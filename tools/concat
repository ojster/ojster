#!/usr/bin/env bash
set -euo pipefail

OUTFILE="ojster-all.go.txt"

# If set (non-empty), comments will be preserved.
# Otherwise, comments are stripped.
PRESERVE_COMMENTS="${OJSTER_INCLUDE_COMMENTS:-}"

echo "// Combined Go source tree for ojster" > "$OUTFILE"
echo "// Generated on $(date)" >> "$OUTFILE"
echo "" >> "$OUTFILE"

find . \
  -type f \
  \( -name "*.go" -o -name "*_test.go" \) \
  ! -path "./vendor/*" \
  ! -path "./.git/*" \
  ! -path "./build/*" \
  | sort \
  | while read -r file; do
      echo "// =============================================" >> "$OUTFILE"
      echo "// FILE: $file" >> "$OUTFILE"
      echo "// =============================================" >> "$OUTFILE"
      echo "" >> "$OUTFILE"

      if [[ -n "$PRESERVE_COMMENTS" ]]; then
        # Keep file exactly as-is
        cat "$file" >> "$OUTFILE"
      else
        # Strip comments while preserving code
        # Removes:
        #   - full-line comments:   ^\s*//
        #   - block comments:       /* ... */
        #   - but keeps code lines even if they contain inline comments
        sed \
          -e 's:/\*.*\*/::g' \
          -e '/^\s*\/\//d' \
          "$file" >> "$OUTFILE"
      fi

      echo "" >> "$OUTFILE"
      echo "" >> "$OUTFILE"
    done

echo "Wrote combined file to: $OUTFILE"
