#!/usr/bin/env bash
set -euo pipefail
export BUILDKIT_PROGRESS=plain

# ----------------------------------------
# COLORS
# ----------------------------------------
BOLD="\033[1m"
RED="\033[31m"
GREEN="\033[32m"
YELLOW="\033[33m"
CYAN="\033[36m"
RESET="\033[0m"

# ----------------------------------------
# CONFIG
# ----------------------------------------
COVERAGE_THRESHOLD="${COVERAGE_THRESHOLD:-80}"

# ----------------------------------------
# RESOLVE REPO ROOT AND CD INTO IT
# ----------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$REPO_ROOT"

# ----------------------------------------
# CLEANUP TRAP
# ----------------------------------------
cleanup() {
    echo -e "${YELLOW}${BOLD}→ Cleanup: clear .env and ojster keys…${RESET}"
    [ -f .env ] && rm .env
    [ -f ojster_pub.key ] && rm ojster_pub.key
    [ -f ojster_priv.key ] && rm ojster_priv.key

    echo -e "${YELLOW}${BOLD}→ Cleanup: stopping docker compose…${RESET}"
    docker compose down -v --remove-orphans >/dev/null 2>&1 || true
}
trap cleanup EXIT

# ----------------------------------------
# CLEAN WORKSPACE
# ----------------------------------------
echo -e "${YELLOW}${BOLD}→ Cleaning log/…${RESET}"

LOG_DIR="log"
rm -r "$LOG_DIR"
mkdir "$LOG_DIR"

# ----------------------------------------
# DOCKER BAKE TEST
# ----------------------------------------
echo -e "${YELLOW}${BOLD}→ Running docker bake test…${RESET}"
docker bake test

# ----------------------------------------
# VERIFY test.log EXISTS
# ----------------------------------------
echo -e "${YELLOW}${BOLD}→ Checking for test.log…${RESET}"

TESTLOG=""
if [ -f "$LOG_DIR/test.log" ]; then
    TESTLOG="$LOG_DIR/test.log"
else
    echo -e "${RED}${BOLD}ERROR:${RESET} test.log not found"
    exit 1
fi

COVERAGETXT=""
if [ -f "$LOG_DIR/coverage.txt" ]; then
    COVERAGETXT="$LOG_DIR/coverage.txt"
else
    echo -e "${RED}${BOLD}ERROR:${RESET} coverage.txt not found"
    exit 1
fi

# ----------------------------------------
# SUMMARIZE FAILED TESTS
# ----------------------------------------
echo -e "${YELLOW}${BOLD}→ Summarizing failed tests…${RESET}"

FAILED_TESTS=$(awk '/^--- FAIL: / { print $3 }' "$TESTLOG")

if [ -n "$FAILED_TESTS" ]; then
    echo -e "${RED}${BOLD}❌ Failed tests:${RESET}"
    echo "$FAILED_TESTS" | while read -r test; do
        echo -e "   ${RED}- ${test}${RESET}"
    done

    COUNT=$(echo "$FAILED_TESTS" | wc -l | tr -d ' ')
    echo -e "${RED}${BOLD}${COUNT} test(s) failed.${RESET}"
    exit 1
else
    echo -e "${GREEN}${BOLD}✓ No failed tests.${RESET}"
fi

# ----------------------------------------
# DOCKER BAKE BUILD
# ----------------------------------------
echo -e "${YELLOW}${BOLD}→ Running docker bake…${RESET}"
docker bake

# ----------------------------------------
# CREATE .env
# ----------------------------------------
echo -e "${YELLOW}${BOLD}→ Creating .env…${RESET}"
echo "EXAMPLE1=1234" > .env

OJSTER_HARDENED=(
  --rm
  -v "$(pwd)":/o
  --pull=never
  -u=64646:64646
  --cap-drop=ALL
  --network=none
  --security-opt=no-new-privileges=true
  ojster/ojster
)

docker run "${OJSTER_HARDENED[@]}" keypair
echo -n '1234' | docker run -i "${OJSTER_HARDENED[@]}" seal EXAMPLE

# ----------------------------------------
# VERIFY .env ENCRYPTED
# ----------------------------------------
echo -e "${YELLOW}${BOLD}→ Checking .env contains encrypted value…${RESET}"
if ! grep -q "=OJSTER-1:" .env; then
    echo -e "${RED}${BOLD}ERROR:${RESET} .env does not contain encrypted value"
    exit 1
fi

# ----------------------------------------
# COMPOSE UP AND VERIFY CLIENT LOGS
# ----------------------------------------
echo -e "${YELLOW}${BOLD}→ Starting docker compose…${RESET}"
docker compose up -d
CLIENT_DIR=examples/01_client
output="$(docker compose --project-directory=. -f ./"$CLIENT_DIR"/compose.base.yaml -f ./"$CLIENT_DIR"/compose.ojster.yaml up --force-recreate 2>&1)"

echo -e "${YELLOW}${BOLD}→ Checking client logs for decrypted EXAMPLE1=1234…${RESET}"

if ! grep -q "EXAMPLE1=1234" <<<"$output"; then
    echo -e "${RED}${BOLD}→ Full client logs:${RESET}"
    echo "$output"
    echo -e "${RED}${BOLD}ERROR:${RESET} client logs do not contain EXAMPLE1=1234"
    exit 1
fi

# ----------------------------------------
# EXTRACT COVERAGE FROM coverage.txt
# ----------------------------------------
echo -e "${YELLOW}${BOLD}→ Extracting coverage percentage…${RESET}"

COVERAGE=$(grep -E "^total:" "$COVERAGETXT" | awk '{print $3}' | tr -d '%')

if [ -z "$COVERAGE" ]; then
    echo -e "${RED}${BOLD}ERROR:${RESET} could not extract coverage from coverage.txt"
    exit 1
fi

echo -e "${CYAN}${BOLD}→ Coverage: ${COVERAGE}%${RESET}"

# ----------------------------------------
# ENFORCE COVERAGE THRESHOLD
# ----------------------------------------
awk -v cov="$COVERAGE" -v req="$COVERAGE_THRESHOLD" '
BEGIN {
    if (cov+0 < req+0) {
        printf("ERROR: coverage %.1f%% is below required %.1f%%\n", cov, req)
        exit 1
    }
}
'

echo -e "${GREEN}${BOLD}✓ All tests passed and coverage is sufficient.${RESET}"
